<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 简单谈谈Redux在项目中的使用 · 70kg</title><meta name="description" content="简单谈谈Redux在项目中的使用 - 70kg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="70kg"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/2790907881/profile?topnav=1&amp;wvr=6&amp;is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/70kg" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">简单谈谈Redux在项目中的使用</h1><div class="post-info">Dec 5, 2016</div><div class="post-content"><h1 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h1><p><code>Reducer</code> :为了描述 <code>action</code> 如何改变 <code>state tree</code>。 输入 <code>action</code> 和 <code>state</code>，一般根据 <code>action</code> 的 <code>type</code> 进行区分，然后处理，改变 <code>state tree</code>。<a id="more"></a></p>
<p><code>Reducer</code> 是纯函数，纯函数就是输入一个值，会输出一个确定的值，也就是 <code>Reducer</code> 里面不应该有 <code>getDate()</code>, 调用 <code>API</code> 等等之类不确定的操作。</p>
<p>e.g :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">const</span> store = configStore(reducers)</div><div class="line"></div><div class="line">    KeyboardReducer</div><div class="line">    </div><div class="line">    <span class="keyword">export</span> <span class="keyword">const</span> setKeyboardHeight = createRequest(<span class="string">'setKeyboardHeight'</span>, (keyboardHeight) =&gt; &#123;</div><div class="line">    <span class="keyword">var</span> oldKeyboarHeight = store.getState()[<span class="string">'keyboardHeight'</span>];</div><div class="line">    <span class="keyword">if</span> (oldKeyboarHeight == keyboardHeight) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;keyboardHeight&#125;;</div><div class="line">&#125;</div><div class="line">    <span class="keyword">export</span> <span class="keyword">default</span> KeyboardReducer = handleActions(&#123;</div><div class="line">        [setKeyboardHeight]: acceptSuccessActionReducer,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="attr">keyboardHeight</span>: <span class="number">0</span>,</div><div class="line">    &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这里有个 <code>KeyboardReducer</code> 的一个自定义的 <code>Reducer</code> ,用来处理键盘高度的事件，先不看实现，这个 <code>Reducer</code> 接受一个 <code>type</code>  为 <code>setKeyboardHeight</code> 的 <code>action</code> ，然后获取原 <code>store</code> 中的 <code>oldState</code> 中的 <code>keyboardHeight</code> ，然后对比，改变 <code>state tree</code> 中的 <code>keyboardHeight</code> 这个 <code>state</code>。 同时可以发现，在创建给某个模块使用的 <code>store</code> 的时候，这个 <code>reducer</code> 已经对 <code>state tree</code> 做了一些改变，设置了 <code>keyboardHeight : 0</code> 这个默认值,举例这个我们可以在cs模块的 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> store = configStore(reducers);</div><div class="line">store.dispatch(getQuestions());</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> store;</div></pre></td></tr></table></figure>
<p>在处理模块自己的 <code>action</code> 之前，断点可以看到</p>
<pre><code>store.getState()[&apos;keyboardHeight&apos;] ：0
</code></pre><p>也就印证了我们的猜想。</p>
<h4 id="拆分-Reducer"><a href="#拆分-Reducer" class="headerlink" title="拆分 Reducer"></a>拆分 <code>Reducer</code></h4><p><code>Reducer</code>接受一个 <code>state</code> 和 <code>action</code> ，返回一个新的 <code>State</code>,如果项目很大，对应的 <code>state</code> 也会很大，如果使用一个 <code>Reducer</code> 进行整个的 <code>state</code> 的处理就会非常的臃肿。这个时候就可以进行拆分 <code>Reducer</code> ,每个 <code>Reducer</code> 去处理自己职责范围内的 <code>state</code> ，类似上面的  <code>KeyboardReducer</code> 就只对 <code>store.getState()[&#39;keyboardHeight&#39;];</code> 这个 <code>stage</code> 感兴趣。 因为 <code>store</code> 只有一个，当分成多个 <code>Reducer</code> 的时候，那就需要一个 <code>Reducer</code> 去管理这些 <code>Reducers</code> 。可以使用 <code>combineReducers</code> 进行 <code>Reducer</code> 的合成，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">state = &#123;&#125;,action</span>)</span>&#123;</div><div class="line">    <span class="keyword">switch</span>(action.type)&#123;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,........);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo1</span>(<span class="params">state = &#123;&#125;,action</span>)</span>&#123;</div><div class="line">    <span class="keyword">switch</span>(action.type)&#123;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;,state,........);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> App = combineReducers(&#123;</div><div class="line">    foo,</div><div class="line">    foo1</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在项目中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> reducers = handleActions(&#123;</div><div class="line">    [setBrandId]: acceptSuccessActionReducer,</div><div class="line">    [getBrandCatalogs]: acceptSuccessActionReducer,</div><div class="line">    [getBrandInfo]: acceptSuccessActionReducer,</div><div class="line">    [setOrderByAndDirect]: acceptSuccessActionReducer,</div><div class="line">    [getFilterInfo]: acceptSuccessActionReducer,</div><div class="line">    [setFilter]: acceptSuccessActionReducer,</div><div class="line">    [followBrand]: acceptSuccessActionReducer,</div><div class="line">    [setPriceSelect]: acceptSuccessActionReducer,</div><div class="line">    [getCampaign]: acceptSuccessActionReducer,</div><div class="line">    [resetgetCampaigned]: acceptSuccessActionReducer,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里每个请求都对于同样的 <code>acceptSuccessActionReducer</code> 这个 <code>Reducer</code>，代码很简单就不贴了，最终这些 <code>reducer</code> 的统一处理是在 <code>createStore</code> 的时候，下面会说到</p>
<p>项目中管理这些 <code>Reducers</code> 是使用了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">reduceReducers(actionStateReducers, KeyboardReducer, reducer)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">reduceReducers</span>(<span class="params">...reducers</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</div><div class="line">        <span class="comment">//框架的安全检查类型，可暂时忽略。。</span></div><div class="line">        <span class="comment">// if (action.type === ActionTypes.INIT) &#123;</span></div><div class="line">        <span class="keyword">if</span> (action.type === <span class="string">'@@redux/INIT'</span>) &#123;</div><div class="line">            <span class="keyword">var</span> state = &#123;&#125;;</div><div class="line">            <span class="comment">// collect all init state.</span></div><div class="line">            reducers.forEach(<span class="function"><span class="params">reduce</span> =&gt;</span> &#123;</div><div class="line">                state = <span class="built_in">Object</span>.assign(state, reduce(<span class="literal">undefined</span>, action));</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span> state;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> reducers.reduce(</div><div class="line">                <span class="comment">//迭代累加调用reducer</span></div><div class="line">                (state, reduce) =&gt; reduce(state, action),</div><div class="line">                state</div><div class="line">            );</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Action"><a href="#Action" class="headerlink" title="Action"></a><code>Action</code></h1><p><code>Action</code>可以理解为一个动作或者事件。它的作用是将信息传递给某个 <code>Reducer</code> 进而去影响 <code>State tree</code>,而使用这些 <code>Action</code> 只有一种方法就是 <code>store.dispatch(action)</code>, 在项目中可以手动去调用，也可以使用 <code>react-redux</code> 的 <code>bindActionCreators</code>方法自动将多个 <code>Action</code> 绑定到 <code>Dispatch()</code> 方法上。这个肯定也是调用了 <code>store.dispatch(action)</code> ,一般的 <code>Action</code> 的结构类似：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    type: &quot;action-type&quot;</div><div class="line">    value: &quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>action</code>的定义十分灵活，一般只有 <code>type</code>是固定的，其他随便。但是在异步的 <code>action</code> 中，通过 <code>actionCreater</code>创建的一般都是 <code>function</code>，返回值才是起作用的 <code>action</code>。</p>
<h1 id="Store"><a href="#Store" class="headerlink" title="Store"></a><code>Store</code></h1><p>每个 <code>Redux</code>应用只有一个 <code>store</code>，如果觉得数据很多很臃肿，应该去使用组合 <code>Reducer</code> 的方法而不是去创建多个 <code>store</code> 解决。 <code>store</code>  有下面几个重要方法：</p>
<ul>
<li><code>store.getState</code> 对当前 <code>store</code> 进行快照，获取当前 <code>store</code> 对应的 <code>state</code>.</li>
<li><code>dispatch(action)</code> 分发 <code>action</code> 给 <code>reducer</code>。</li>
<li><code>subscribe(listener)</code> 注册监听器，当 <code>store</code> 改变时回调监听器。</li>
</ul>
<p>e.g.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">store.subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="comment">//当进入品牌详情页面，设置brandId导致store的改变，进而回调这里，去请求网络。</span></div><div class="line">    <span class="keyword">var</span> brandId = store.getState()[<span class="string">'brandId'</span>];</div><div class="line">    <span class="keyword">if</span>(brandId &amp;&amp; brandId !== lastBrandId) &#123;</div><div class="line">        lastBrandId = brandId;</div><div class="line">        store.dispatch(getBrandInfo());</div><div class="line">        store.dispatch(getFilterInfo());</div><div class="line">        store.dispatch(getBrandCatalogs(<span class="literal">true</span>));</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h1 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a><code>Middleware</code></h1><p>对于中间件，看这个就够了，我也说不了比它更好：</p>
<p><a href="http://cn.redux.js.org/docs/advanced/Middleware.html" target="_blank" rel="external">点击了解Middleware</a></p>
<h1 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h1><p>来简单的看一下项目中的一个请求 <code>action</code> 是如果经过一步步到最终 UI 上面展示的。先从创建 <code>Store</code> 开始，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//参数reducer是我们在模块中自己定义 一般一个请求对应一个reducer 参考actions目录</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">configStore</span>(<span class="params">reducer</span>) </span>&#123;</div><div class="line">    <span class="comment">//createStore 第一个参数是reducer</span></div><div class="line">    <span class="keyword">const</span> store = createStore(</div><div class="line">        <span class="comment">//array.reducer类似一个迭代累加的效果 这里就是迭代去调用各种reducer,累加对store的影响</span></div><div class="line">        <span class="comment">//actionStateReducers:主要是为了异步的action 自动多了ACTION_WILL_START,ACTION_WILL_END这两个action</span></div><div class="line">        <span class="comment">//KeyboardReducer :处理键盘的</span></div><div class="line">        <span class="comment">//我们在模块中自己定义的各个reducer 详情见模块下的actions/index.js 中的export const reducers = handleActions。。。。。</span></div><div class="line">        <span class="comment">//类似注册的作用 预先创建各个 Reducers 到使用的时候一般由下面的中间件中调用。</span></div><div class="line">        reduceReducers(actionStateReducers, KeyboardReducer, reducer),</div><div class="line">        </div><div class="line">        <span class="comment">//Middleware作用在action创建之后,到达reducer之前的阶段</span></div><div class="line">        <span class="comment">//actionStateMiddleware:对应上面的actionStateReducers,处理多出来的两个action</span></div><div class="line">        <span class="comment">//会去调用上面注册的东西</span></div><div class="line">        applyMiddleware(actionStateMiddleware, errorHandlerMiddleware, promiseMiddleware, createLogger(&#123;</div><div class="line">            <span class="attr">predicate</span>: <span class="function"><span class="keyword">function</span> (<span class="params">state, action</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (action.type === <span class="string">'ACTION_WILL_START'</span> || action.type === <span class="string">'ACTION_WILL_END'</span> || action.type === <span class="string">'CONCURRENT_EXECUTION_ERROR'</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">            &#125;,</div><div class="line">        &#125;))</div><div class="line">    );</div><div class="line"></div><div class="line">    global.store = store;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> store;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们去创建一个请求，都是使用 <code>createRequest</code> ，其实也就是创建了一个 <code>action</code> ，但是这个 <code>action</code> 是个 <code>function</code>，这个 <code>function</code>的返回值是真正的 <code>action</code>， 这个先不管，但是起作用的 <code>action</code> 结构类似 ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//同步 &#123;</span></div><div class="line">        <span class="comment">//   type:setBrandId</span></div><div class="line">        <span class="comment">//   payload:object</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line"><span class="comment">//异步&#123;</span></div><div class="line">        <span class="comment">//   type:getBrand</span></div><div class="line">        <span class="comment">//   payload:promise</span></div><div class="line">        <span class="comment">// &#125;</span></div></pre></td></tr></table></figure>
<p>对于最常用的异步 <code>action</code> ,对应与 <code>actionStateReducers</code> 这个 <code>reducer</code> ，详情：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//每个action都会多创建这两个action，在原始action开始和结束的时候分发。</span></div><div class="line"><span class="keyword">const</span> actionWillStart = createAction(<span class="string">'ACTION_WILL_START'</span>);</div><div class="line"><span class="keyword">const</span> actionDidEnd = createAction(<span class="string">'ACTION_WILL_END'</span>);</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">const</span> actionStateReducers = handleActions(&#123;</div><div class="line">    [actionWillStart]: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</div><div class="line">        <span class="keyword">var</span> actionName = action.payload;<span class="comment">//请求回来的数据会在action.payload中 进而去改变store action type也就是请求名</span></div><div class="line"></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'调用处理开始的action的地方,action--&gt;'</span>, action);</div><div class="line"></div><div class="line">        <span class="comment">//state中包含actionstate和我们自己定义的各种state</span></div><div class="line">        <span class="keyword">var</span> actionState = state[<span class="string">'actionState'</span>];</div><div class="line">        <span class="comment">//actionstate的结构类似这样:</span></div><div class="line">        <span class="comment">//&#123;</span></div><div class="line">        <span class="comment">// getLiveShow:1   //是action的名称 和 数量 这个数量暂时还不知道是干什么用的  一般就是0或者1</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line">        <span class="keyword">var</span> count = actionState[actionName];</div><div class="line">        <span class="keyword">if</span> (count) &#123;</div><div class="line">            count += <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            count = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        actionState[actionName] = count;</div><div class="line">        <span class="comment">//如果是ACTION_WILL_START这个action  就把对应的action中的actionstate +1 表明创建了这个一个action??</span></div><div class="line">        <span class="comment">//然后应用修改的state</span></div><div class="line">        <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;actionState&#125;);</div><div class="line">    &#125;,</div><div class="line">    <span class="comment">//这个是ACTION_WILL_END 同上</span></div><div class="line">    [actionDidEnd]: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;<span class="comment">//在数据回来的时候调用</span></div><div class="line">        <span class="keyword">var</span> actionName = action.payload;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> actionState = state[<span class="string">'actionState'</span>];</div><div class="line">        <span class="keyword">var</span> count = actionState[actionName];</div><div class="line">        --count;</div><div class="line">        actionState[actionName] = count;</div><div class="line"></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'调用处理结束的action的地方,action--&gt;'</span>, action);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, &#123;actionState&#125;);</div><div class="line">    &#125;,</div><div class="line">&#125;, &#123;</div><div class="line">    <span class="attr">actionState</span>: &#123;&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p> 上面的代码主要是帮我们多创建了两个 <code>action</code>，而何时去调用，调用的顺序是在下面的 <code>actionStateMiddleware</code> 中定义的，详情：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">actionStateMiddleware</span>(<span class="params">&#123;dispatch, getState&#125;</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</div><div class="line">            <span class="comment">// action throttling</span></div><div class="line">            <span class="keyword">if</span> (isPromise(action.payload)) &#123;</div><div class="line">                <span class="keyword">if</span> (action.type == <span class="string">'CONCURRENT_EXECUTION_ERROR'</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> next(action);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="built_in">console</span>.log(<span class="string">'进来中间件,action--&gt;'</span>, action);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (action.type !== actionWillStart.toString() &amp;&amp;</div><div class="line">                    action.type !== actionDidEnd.toString()) &#123;</div><div class="line">                    <span class="built_in">console</span>.log(<span class="string">'分发开始的action,action--&gt;'</span>, action);</div><div class="line">                    dispatch(actionWillStart(action.type));<span class="comment">//不是那两种 action, 分发actionWillStart:&#123;type:action.type&#125;</span></div><div class="line">                &#125;</div><div class="line">                <span class="comment">//这里的payload是个promise</span></div><div class="line">                action.payload.then(</div><div class="line">                    <span class="function"><span class="params">result</span> =&gt;</span> &#123;</div><div class="line">                        <span class="keyword">if</span> (action.type !== actionWillStart.toString() &amp;&amp;</div><div class="line">                            action.type !== actionDidEnd.toString()) &#123;</div><div class="line">                            <span class="built_in">console</span>.log(<span class="string">'分发结束的action,action--&gt;'</span>, action);</div><div class="line">                            dispatch(actionDidEnd(action.type));<span class="comment">//数据回来的时候 调用这个</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    error =&gt; &#123;</div><div class="line">                        <span class="keyword">if</span> (action.type !== actionWillStart.toString() &amp;&amp;</div><div class="line">                            action.type !== actionDidEnd.toString()) &#123;</div><div class="line">                            dispatch(actionDidEnd(action.type));</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                );</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (isFSA(action) &amp;&amp; !action.error &amp;&amp; !action.payload) &#123;</div><div class="line">                <span class="comment">// return action directly, and the payload will not be reduced into store.</span></div><div class="line">                <span class="keyword">return</span> action;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> next(action);</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而处理原始的 <code>action</code> 则是在 <code>acceptSuccessActionReducer</code> 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">acceptSuccessActionReducer</span>(<span class="params">state, action</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!action.error &amp;&amp; action.payload) &#123;</div><div class="line"></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'调用处理原始的action的地方,action--&gt;'</span>, action);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, state, action.payload);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> state;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>何时去调用则是在 <code>promiseMiddleware</code> 这个中间件中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">....略</div><div class="line"> return isPromise(action.payload) ? action.payload.then(function (result) &#123;</div><div class="line">        return dispatch(_extends(&#123;&#125;, action, &#123; payload: result &#125;));</div><div class="line">....</div></pre></td></tr></table></figure>
<p>最后以品牌详情切换排序方式为例，看一下完整的 <code>action</code> 到 UI 改变的过程。</p>
<p><img src="http://7xjlmz.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-12-04%20%E4%B8%8B%E5%8D%888.54.40.png" alt=""> </p>
<p>无论是开始还是结束的action，都会触发 <code>state</code> 中的 <code>actionState</code> 的改变，进而触发 <code>store</code> 的改变，进而触发页面中 <code>state</code> 的更新。所以会出现多次更新 UI的情况。</p>
<p>createRequest<br>-&gt;dispatch(action)<br>-&gt;actionStateMiddleware<br>-&gt;dispatch(actionWillStart(action.type))<br>-&gt;reduceReducers<br>-&gt;迭代执行reducers(1:包括start,end的actionStateReducers，2：KeyboardReducer，3：模块中定义的reducers：handactions(…..))<br>-&gt;调用handleActions中start action对应的reducer逻辑<br>-&gt;修改start action 对应的actionstate<br>-&gt;请求结果返回<br>-&gt;调用handleActions中end action对应的reducer逻辑<br>-&gt;修改end action 对应的actionstate<br>-&gt;调用promiseMiddleware中的promise响应<br>-&gt;修改store<br>-&gt;调用组件中mapStateToProps<br>-&gt;调用componentWillReceiveProps。</p>
<h2 id="Why-Redux"><a href="#Why-Redux" class="headerlink" title="Why Redux"></a><code>Why Redux</code></h2><p>扯了半天，为什么要用 <code>Redux</code>? 它的定义是 :<strong>Redux 是 JavaScript 状态容器，提供可预测化的状态管理。</strong> 为什么说是可预测的状态，因为一个确定的 <code>state</code> 就对应一个确定的 <code>view</code>，使用 <code>Redux</code> 能感受到它的数据的单向流动性，用户触发某个动作，发出一个 <code>action</code> ，经过 <code>Reducer</code>,改变 <code>store</code> 的数据，进而去控制 UI的效果，仅仅有这一种方式，单向数据流也保证了可预测的状态。如果不这样做，我们的 <code>View</code> 可以被各种各样的 <code>event</code>,<code>Model</code>甚至其他的 <code>View</code>控制，一个 <code>View</code> 的状态无法预测，当改变因素很多的时候就无法控制。这只是我浅显的理解。<br><img src="http://7xjlmz.com1.z0.glb.clouddn.com/WechatIMG4.jpeg" alt=""></p>
<h2 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h2><p>好大老师改了原 <code>actions/index.js</code>和 <code>store/index.js</code>，结合了这两个，看完了上面的这些东西，再去看改动应该就没什么压力了，也更理解为什么这么改。</p>
</div></article></div></main><footer><div class="paginator"></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
    url: document.location.href,
    sourceId: "posts_backup/Redux-1.html",
    productKey: "f39e35695dd943529768f0f9c5440f14",
    target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">70kg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-81769413-1",'auto');ga('send','pageview');</script></body></html>