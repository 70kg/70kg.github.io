<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Router设计 · 70kg</title><meta name="description" content="Router设计 - 70kg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="70kg"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/应聘Android开发工程师_王鹏.pdf" target="_self" class="nav-list-link">RESUME</a></li><li class="nav-list-item"><a href="/book/" target="_self" class="nav-list-link">BOOKS</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Router设计</h1><div class="post-info">Nov 16, 2016</div><div class="post-content"><p>&emsp;&emsp;最近公司的项目要进行页面间跳转的重构，首先项目是单 <code>Activity</code> + 多 <code>Fragment</code> 的结构，因为是电商的项目，所以涉及到很多 H5 , <code>Native</code> 和 <code>React Native</code> 页面之间的交互与跳转，这篇不是介绍两者之间是如何进行通信的，而是当 H5 或者外部分享的链接打开后传递过来 <code>Uri</code> 要解析跳转到 <code>Native</code> 的页面的处理。当然各个页面的 <code>Host</code>  是提前统一定义好的，具体的做法这里也不说了，也没什么难点。原来的写法是都放到一个 <code>Util</code> 类里面，各种 <code>Switch</code> <code>Case</code> 来进行分支判断，当项目越来越大维护起来十分的困难，而且本身 <code>Native</code> 的页面之间还有一套跳转的逻辑，同时维护两套的代价是很大的，所有希望将项目重构一下，统一两端的处理逻辑，就产生了下面的这个路由结构。<a id="more"></a></p>
<p>&emsp;&emsp;在开始重构之前，也是去搜索了一下网上的一些开源例子，绝大多数都是基于 <code>Activity</code> 的跳转，写的功能虽然很多，但是对于我们的项目却是很冗余并且也不怎么合适，所以要去定制一套适合自己的路由，目标就是统一 H5 , <code>Native</code> 和 <code>React Native</code> 这三端之间的跳转逻辑，同时做到简单易用，容易维护和容易拓展。去写人人都能很容易看的懂的代码，而不是写那么花里胡哨的各种”炫技”的代码。</p>
<p>&emsp;&emsp;先放一下这个项目的类图，不怎么熟悉 <code>UML</code>,里面有些关系表示的不正确，大概的意思还是可以表达出来的。首先要去统一两端的逻辑，肯定需要在跳转直接转换成统一的 <code>Uri</code> 进行跳转，从 H5 过来的就很简单就是个 <code>Uri</code>,而 <code>Native</code> 的跳转则要去进行处理拼接，然后通过统一的路由进行处理，最后跳转到具体的页面。</p>
<p><img src="http://7xjlmz.com1.z0.glb.clouddn.com/Class%20Diagram%20%282%29.png" alt=""></p>
<p>&emsp;&emsp;先说一下设计的思想，一个页面对应一个 <code>Uri</code>,并且使用不同的 <code>Host</code> 或者 <code>Path</code> 进行区分和信息的传递，这里先建立了一个全局的”路由表”,让 <code>Url</code> 和一个具体页面的切换器进行对应，当路由获取到一个 <code>Uri</code> 的时候，在路由表中找到对应的切换器，切换到具体的页面。当然在切换之前还需要一些其他的处理，这里加入了拦截器的机制，默认实现了两种拦截器，<code>LoginInterceptor</code> 和 <code>LogInterceptor</code> 分别进行需要登录页面的 <code>Uri</code> 的拦截使其跳转到登录页面和打印 <code>Uri</code> 和其他跳转参数。当然也可以去实现其他的拦截器，这样就使得整个路由十分的灵活。</p>
<p>&emsp;&emsp;说一下怎么使用，首先在 <code>Application</code> 中初始化路由表，这个路由表是个 <code>pageMap : Map&lt;String, Switcher&gt;</code> ，这里的 <code>Key</code> 就是每个页面对应的 <code>Host</code> ,<code>Value</code> 的 <code>Switcher</code> 就是处理每个页面切换逻辑的地方，类似这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pageMap.put(REACT_NATIVE, new RnSwitcher());</div><div class="line">pageMap.put(SCHEMA_HTTP, new H5Switcher());</div><div class="line">pageMap.put(HOST_CATALOG, new CatalogDetailSwitcher());</div></pre></td></tr></table></figure>
<p>这样就初始化了全局的路由表。因为是单 <code>Activity</code> +多 <code>Fragment</code> 的结构，几乎所有的页面都是 <code>Fragment</code> ,不像切换 <code>Activity</code> 那么简单，这里要去处理相对复杂的 <code>Fragment</code> 的切换逻辑和维护回退栈的操作，所以封装了一个 <code>NavigationManager</code> 用来处理这些操作。看一下初始化的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Router.install(mNavigationManager)</div><div class="line">            .addInterceptor(new LoginInterceptor())</div><div class="line">            .addInterceptor(new LogInterceptor());</div></pre></td></tr></table></figure>
<p>因为要持有 <code>Activiry</code> 所以要在 <code>onDestroy</code> 的时候及时释放引用 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Router.unInstall();</div></pre></td></tr></table></figure>
<p>然后看一下具体的跳转：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Router.config().setUri(uri).start()</div></pre></td></tr></table></figure>
<p>这样就可以跳转到具体的页面了，当然只是简单的示例一下，实际使用的时候肯定还有其他的配置。因为使用者不可能记得每个页面的 <code>Uri</code> 是怎么拼接的，所以还可以在写个工具类来封装一下，这个就不说了。</p>
<p> &emsp;&emsp;说一下这个路由的优点：</p>
<ol>
<li>简单易懂，几乎人人都读得懂，基本不需要学习成本。更没有任何的注解反射之类的。</li>
<li>方便统一进行跳转管理，使用了拦截器，可以打印出跳转中的 <code>Uri</code> 和其他参数，调试十分方便。加入了登录拦截器，使得跳转可以无脑跳转，无需关心页面是否需要登录，路由帮你做好了判断和后续登录成功跳转到目标页面。</li>
<li>容易拓展，无论是新增页面还是修改维护旧页面。将每个页面切换逻辑封装到对应的 <code>Switcher</code> 里面，快速定位。</li>
<li>统一 <code>H5</code> , <code>Native</code> 和 <code>React Native</code> 三端的跳转，更加方便维护。</li>
<li>啦啦啦啦。。。</li>
</ol>
<p>&emsp;&emsp;以后甚至可以将路由表让服务端去控制，无论是灵活性还是稳定性都大大提高，只是目前还没有这样的需求，但是改造起来将十分的简单。这个路由从设计到项目的改造大概花了一周的时间，也算是独立设计开发的完整的重要模块，现在还处于比较初级的阶段，肯定有提升空间。目前用在 <a href="http://www.bolome.com/" target="_blank" rel="external">波罗蜜全球购</a> 的 <code>Android</code> 客户端中，欢迎大家支持。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/05/Redux-1/" class="prev">上一篇</a><a href="/2016/09/30/Redux/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = '70kg-info';
var disqus_identifier = '2016/11/16/Router设计/';
var disqus_title = 'Router设计';
var disqus_url = 'http://yoursite.com/2016/11/16/Router设计/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//70kg-info.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">70kg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-81769413-1",'auto');ga('send','pageview');</script></body></html>