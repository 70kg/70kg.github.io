<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RxJava和Retrofit的那些事 · 70kg</title><meta name="description" content="RxJava和Retrofit的那些事 - 70kg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="70kg"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/2790907881/profile?topnav=1&amp;wvr=6&amp;is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/70kg" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">RxJava和Retrofit的那些事</h1><div class="post-info">Aug 1, 2016</div><div class="post-content"><p>##关于Retrofit<br>这是一个最近很火的网络请求库，官网在这<a href="http://square.github.io/retrofit/" target="_blank" rel="external">官网</a>,当然这也是一个开源的项目<a href="https://github.com/square/retrofit" target="_blank" rel="external">GitHub地址</a>。可能你对这个不是很熟悉，但是说起他的兄弟，okhttp估计就比较熟悉了，还有大名鼎鼎的依赖注入dagger和图片加载库picasso还有检查内存泄露的LeakCanary都是出自Square公司。当然这只是在JAVA和Android端，在js和Python上也有很棒的项目，有兴趣就自己看了，扯远了。。<a id="more"></a></p>
<p>为什么要用Retrofit呢，因为他除了提供给我们常见的请求Callback形式，还封装了Observable的请求形式，这就很方便的支持了Rxjava,而Rxjava的强大就是体现在异步任务上。下面来简单的介绍一下使用。</p>
<p>对于RxJava的语法就不说了，有一篇写了关于这方面的，下面就直接开始了。</p>
<p>以github的开放API作为数据来源，我们要去获取某个项目的contributors，以square的retrofit为例，可以调用这个<code>https://api.github.com/repos/square/retrofit/contributors</code>返回的json是这样的array</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">login: &quot;JakeWharton&quot;,</div><div class="line">id: 66577,</div><div class="line">avatar_url: &quot;https://avatars.githubusercontent.com/u/66577?v=3&quot;,</div><div class="line">gravatar_id: &quot;&quot;,</div><div class="line">url: &quot;https://api.github.com/users/JakeWharton&quot;,</div><div class="line">html_url: &quot;https://github.com/JakeWharton&quot;,</div><div class="line">followers_url: &quot;https://api.github.com/users/JakeWharton/followers&quot;,</div><div class="line">following_url: &quot;https://api.github.com/users/JakeWharton/following&#123;/other_user&#125;&quot;,</div><div class="line">gists_url: &quot;https://api.github.com/users/JakeWharton/gists&#123;/gist_id&#125;&quot;,</div><div class="line">starred_url: &quot;https://api.github.com/users/JakeWharton/starred&#123;/owner&#125;&#123;/repo&#125;&quot;,</div><div class="line">subscriptions_url: &quot;https://api.github.com/users/JakeWharton/subscriptions&quot;,</div><div class="line">organizations_url: &quot;https://api.github.com/users/JakeWharton/orgs&quot;,</div><div class="line">repos_url: &quot;https://api.github.com/users/JakeWharton/repos&quot;,</div><div class="line">events_url: &quot;https://api.github.com/users/JakeWharton/events&#123;/privacy&#125;&quot;,</div><div class="line">received_events_url: &quot;https://api.github.com/users/JakeWharton/received_events&quot;,</div><div class="line">type: &quot;User&quot;,</div><div class="line">site_admin: false,</div><div class="line">contributions: 619</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>这里我们只使用到<code>login</code>和<code>contributions</code></p>
<p> 1.定义一个接口，这个看代码就明白了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public interface GithubApi &#123;</div><div class="line"> @GET(&quot;/repos/&#123;owner&#125;/&#123;repo&#125;/contributors&quot;)</div><div class="line">    Observable&lt;List&lt;Contributor&gt;&gt; contributors(@Path(&quot;owner&quot;) String owner,</div><div class="line">                                               @Path(&quot;repo&quot;) String repo);</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>通过注解来提供参数，这里注解有很多，还有<code>@Query</code>，<code>@QueryMap</code>，<code>@Body</code>等等，也可以通过<code>@Headers</code>设置请求头。参数基于base url,其实就是拼接成的。这个返回的是一个<code>Observable</code>，这样就很方便的去发布一个事件了。</p>
<p> 2.设置<code>RestAdapter</code>和<code>service</code>,先用<code>Endpoint(API)</code>并调用buid()方法来创建一个RestAdapter对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RestAdapter adapter = new RestAdapter.Builder().setEndpoint(</div><div class="line">              &quot;https://api.github.com/&quot;).setLogLevel(RestAdapter.LogLevel.FULL).build();</div></pre></td></tr></table></figure>
<p>然后使用我们的adapter来创建一个服务适配器(service for adapter)。<code>adapter.create(GithubApi.class);</code><br>完整的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">private GithubApi _createGithubApi() &#123;</div><div class="line">      RestAdapter adapter = new RestAdapter.Builder().setEndpoint(</div><div class="line">            &quot;https://api.github.com/&quot;).setLogLevel(RestAdapter.LogLevel.FULL).build();</div><div class="line"></div><div class="line">      return adapter.create(GithubApi.class);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p> 3.这就到了Rxjava的地方了，上一步获取到了GithubApi对象，就可以去调用函数了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">_subscriptions.add(</div><div class="line">                _api.contributors(_username.getText().toString(), _repo.getText().toString())//事件源</div><div class="line">                        .subscribeOn(Schedulers.io())</div><div class="line">                        .observeOn(AndroidSchedulers.mainThread())</div><div class="line">                        .subscribe(new Observer&lt;List&lt;Contributor&gt;&gt;() &#123;//订阅者</div><div class="line">                            @Override</div><div class="line">                            public void onCompleted() &#123;</div><div class="line">                                </div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            @Override</div><div class="line">                            public void onError(Throwable e) &#123;</div><div class="line">                               </div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            @Override</div><div class="line">                            public void onNext(List&lt;Contributor&gt; contributors) &#123;</div><div class="line">                                for (Contributor c : contributors) &#123;</div><div class="line">                                    _adapter.add(format(&quot;%s has made %d contributions to %s&quot;,</div><div class="line">                                            c.login,</div><div class="line">                                            c.contributions,</div><div class="line">                                            _repo.getText().toString()));</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;));</div></pre></td></tr></table></figure>
<p>当然这是一个比较简单的处理过程，并没有用到一下通配符，但是基本的流程就是这样的。</p>
<p>到现在发现我们并没有去解析json数据就自动生成了bean类，这是因为Retrofit已经集成了Gson，并且默认使用Gson来进行解析，当然你也可以自己去定义。在创建<code>RestAdapter</code>的时候使用<code>setConverter(new GsonConverter(gson))</code>。默认是使用okhttp进行加载的，当然你也可以去配置一些关于<code>OkHttpClient</code>的数据，然后通过<code>setClient(new OkClient(client))</code>进行设置进去。</p>
<p>现在<code>Retrofit</code>的2.0版本已经出了，主要就是 取消了同步和异步，可以取消正在进行中的业务，取消了Gson的依赖等等，具体可以看这里<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0915/3460.html" target="_blank" rel="external">Retrofit 2.0：有史以来最大的改进</a><br>这篇参考了GitHub上的项目<a href="https://github.com/70kg/RxJava-Android-Samples" target="_blank" rel="external">RxJava-Android-Samples</a>，这里只是拣取了关于Retrofit的部分，有兴趣可以看看其他的。</p>
<p>参考：<br><a href="http://www.tuicool.com/articles/26jUZjv" target="_blank" rel="external">http://www.tuicool.com/articles/26jUZjv</a><br><a href="http://www.cnblogs.com/angeldevil/p/3757335.html" target="_blank" rel="external">http://www.cnblogs.com/angeldevil/p/3757335.html</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/08/01/浅谈CoordinatorLayout/" class="prev">上一篇</a><a href="/2016/08/01/自定义控件学习笔记/" class="next">下一篇</a></div><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = {
    url: document.location.href,
    sourceId: "2016/08/01/RxJava和Retrofit的那些事/",
    productKey: "f39e35695dd943529768f0f9c5440f14",
    target: "cloud-tie-wrapper"
};
var yunManualLoad = true;
Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);</script><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com">70kg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-81769413-1",'auto');ga('send','pageview');</script></body></html>